{% extends 'materialize/base_materialize.html' %}
{% load static %}
{% block extra_js %}
    <script src="{% static 'Highcharts/highcharts.js' %}"></script>
    <script src="{% static 'Highcharts/modules/heatmap.js' %}"></script>
    <script src="{% static 'Highcharts/modules/exporting.js' %}"></script>
    <script type="text/javascript">
        $(document).ready(function () {
            $("#applyFilterBtn").click(function () {
                collapseAll();
                var skills_filters = [];
                $(".skillbox").each(function () {
                    if ($(this).is(':checked')) {
                        skills_filters.push($(this).val());
                    }
                });
                var dev_filters = [];
                $(".devbox").each(function () {
                    if ($(this).is(':checked')) {
                        dev_filters.push($(this).val());
                    }
                });
                var filter_data = {'skills': skills_filters, 'devs': dev_filters};
                console.log("FILTER DATA: ");
                console.log(filter_data);
                $.ajax({
                    method: "GET",
                    url: "/matrix/filter-matrix/",
                    data: filter_data
                }).done(function (contextdata) {
                    developers = contextdata["dev_names"];
                    skills = contextdata["skill_names"];
                    dev_skills = contextdata["dev_skills"];

                    Highcharts.chart('skillmatrix', {
                        chart: {
                            type: 'heatmap',
                            marginTop: 40,
                            marginBottom: 80,
                            plotBorderWidth: 1
                        },
                        title: {
                            text: 'Skills Matrix'
                        },
                        xAxis: {
                            categories: developers
                        },
                        yAxis: {
                            categories: skills,
                            title: null
                        },
                        colorAxis: {
                            min: 0,
                            minColor: '#FFFFFF',
                            maxColor: Highcharts.getOptions().colors[0]
                        },
                        legend: {
                            enabled: false
                        },
                        tooltip: {
                            formatter: function () {
                                return '<b>' + this.series.xAxis.categories[this.point.x] + '</b> has proficiency of <br><b>' +
                                        this.point.value + '</b> in <br><b>' + this.series.yAxis.categories[this.point.y]
                                        + '</b>';
                            }
                        },
                        series: [{
                            name: 'Employee Skills',
                            borderWidth: 1,
                            data: dev_skills,
                            dataLabels: {
                                enabled: true,
                                color: '#000000'
                            },
                            navigation: {
                                buttonOptions: {
                                    verticalAlign: 'bottom',
                                    y: -20
                                }
                            }
                        }]
                    });
                });
            });

            Highcharts.chart('skillmatrix', {

                chart: {
                    type: 'heatmap',
                    marginTop: 40,
                    marginBottom: 80,
                    plotBorderWidth: 1
                },


                title: {
                    text: 'Skills Matrix'
                },

                xAxis: {
                    categories: {{ developers | safe }}
                },

                yAxis: {
                    categories: {{ skills | safe }},
                    title: null
                },

                colorAxis: {
                    min: 0,
                    minColor: '#FFFFFF',
                    maxColor: Highcharts.getOptions().colors[0]
                },

                legend: {
                    enabled: false
                },

                tooltip: {
                    formatter: function () {
                        return '<b>' + this.series.xAxis.categories[this.point.x] + '</b> has proficiency of <br><b>' +
                                this.point.value + '</b> in <br><b>' + this.series.yAxis.categories[this.point.y]
                                + '</b>';
                    }
                },

                series: [{
                    name: 'Employee Skills',
                    borderWidth: 1,
                    data: {{ devskills }},
                    dataLabels: {
                        enabled: true,
                        color: '#000000'
                    },
                    navigation: {
                        buttonOptions: {
                            verticalAlign: 'bottom',
                            y: -20
                        }
                    }
                }]
            });
        });

    function collapseAll(){
  $(".collapsible-header").removeClass(function(){
    return "active";
  });
  $(".collapsible").collapsible({accordion: true});
  $(".collapsible").collapsible({accordion: false});
}
    </script>
{% endblock %}
{% block content %}
    <div class="container">
        <ul class="collapsible popout" data-collapsible="accordion">
            <li>
                <div class="collapsible-header"><i class="material-icons">add</i>Filter</div>
                <div class="collapsible-body">

                    <form>
                        <div class="row">
                            <div id="skill-col" class="col sm3" style="padding-left: 75px;  padding-right: 75px">
                                <br/>
                                <strong>By Skill</strong>
                                <br/><br/>
                                {% for skill in skills %}
                                    <input type="checkbox" id="{{ skill }}-skill" class="skillbox" value="{{ skill }}"/>
                                    <label for="{{ skill }}-skill">{{ skill }}</label>
                                    <br/>
                                {% endfor %}
                            </div>
                            <div class="col sm3" style="padding-left: 75px; padding-right: 75px">
                                <br/>
                                <strong>By Developer</strong>
                                <br/><br/>
                                {% for dev in dev_filter_list %}
                                    <input type="checkbox" id="{{ dev.last_name }}-developer" class="devbox"
                                           value="{{ dev.id }}"/>
                                    <label for="{{ dev.last_name }}-developer">{{ dev.first_name }} {{ dev.last_name }}</label>
                                    <br/>
                                {% endfor %}
                            </div>
                        </div>
                        <div class="row right-align" style="padding-left: 50px; padding-right: 50px">
                            <a class="btn waves-effect waves-light blue" id="applyFilterBtn">
                                <i class="fa fa-filter"></i>Apply
                            </a>
                        </div>
                    </form>
                </div>
            </li>
        </ul>
        <div id="skillmatrix" style="height: 600px; min-width: 310px; max-width: 1000px; margin: 0 auto"></div>
    </div>
{% endblock content %}